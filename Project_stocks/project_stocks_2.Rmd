---
title: "Project_SingRs"
output: html_document
---

##Acknowledgement: Frederico Belo, Ahmed Guecioueur
###Reproduction 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load required packages
```{r, echo=FALSE}
if("pacman" %in% rownames(installed.packages()) == FALSE) {install.packages("pacman")} # Check if you have universal installer package, install if not

pacman::p_load("caret","ROCR","lift","glmnet","MASS","e1071",'dplyr',
               "partykit","rpart", "munsell","caTools", "caret", "randomForest") #Check, and if needed install the necessary packages
```

## Prediction of stock Movements on stock exchange 

We will do the analysis of past share prices of the S&P500 companies, trading volumes, bid low, ask high, price volatiilty to predict the Movement of the stock next day. 

- Data would be used from WRDS CRSP

```{r data_loading}
data_general <- read.csv("vixcurrent.csv")
data_working <- data_general
str(data_working)
```


###Split the data into testing and training
```{r data_split_cleaning}
data_working$Date <- as.Date(as.character(data_working$Date), "%d/%m/%y")
data_working <- ts(data_working, start="01-02-2004", frequency = 252)
```


<<<<<<< HEAD
```{r time_series_analysis}
vix_model <- ets(data_working, model = "ZZZ")




=======
Numtrd 
 - check for 99 (means number unavailable)
```{r, check Numtrd}
which(c(data_working$NUMTRD.T.5, data_working$NUMTRD.T.4, data_working$NUMTRD.T.3, data_working$NUMTRD.T.2, data_working$NUMTRD.T.1, data_working$NUMTRD.T.0) == 99, arr.ind = TRUE)
# Confirm no 99s
```
 
##Feature engineerring
Create log returns + lag
Create volatility

###Split the data into testing and training
```{r data_split_cleaning}
data_working$date <- NULL

#data_working$date <- as.Date(data_working$date, "%d.%b.%y")
#data_working$VOL.T.10 <- as.numeric(data_working$VOL.T.10)
#data_working$VOL.T.9 <- as.numeric(data_working$VOL.T.9)
#data_working$VOL.T.8 <- as.numeric(data_working$VOL.T.8)
#data_working$VOL.T.7 <- as.numeric(data_working$VOL.T.7)
#data_working$VOL.T.6 <- as.numeric(data_working$VOL.T.6)
#data_working$VOL.T.5 <- as.numeric(data_working$VOL.T.5)
#data_working$VOL.T.4 <- as.numeric(data_working$VOL.T.4)
#data_working$VOL.T.3 <- as.numeric(data_working$VOL.T.3)
#data_working$VOL.T.2 <- as.numeric(data_working$VOL.T.2)
#data_working$VOL.T.1 <- as.numeric(data_working$VOL.T.1)
data_working$MOVEMENT.T.0 <- as.factor(data_working$MOVEMENT.T.0)

#data_working<-fixNAs(data_working)
#data_working<-fixNegatives(data_working)


#data_working_wT0 <- data_working[,1:50]
#data_working_wT0 <- cbind(data_working_wT0, data_working$MOVEMENT.T.0)
#names(data_working_wT0)[51] <- paste("MOVEMENT.T.0")

#add extra columns for the difference in volume
data_working$VOL.T.5.4 <-data_working$VOL.T.5 - data_working$VOL.T.4
data_working$VOL.T.4.3 <-data_working$VOL.T.4 - data_working$VOL.T.3
data_working$VOL.T.3.2 <-data_working$VOL.T.3 - data_working$VOL.T.2
data_working$VOL.T.2.1 <-data_working$VOL.T.2 - data_working$VOL.T.1


train_general <- data_working[1:2000,]
test_general <- data_working[2001:2764,]
test_general_womov <- test_general
test_general_womov$MOVEMENT.T.0 <- NULL
>>>>>>> c435cff489682a23339f90ebb4d59d17c562f9eb
```

```{r hmm}
library(ldhmm)
library(moments)
ts = ldhmm.ts_log_rtn("spx", on ="days")
sapply(0:10, function (drop) kurtosis(ldhmm.drop_outliers(ts$x, drop)))
ldhmm.ts_abs_acf(ts$x,drop =0 , lag.max =6)
ldhmm.ts_abs_acf(ts$x,drop =10, lag.max =6)


mu_1 = 0.0006
sigma_1 = 0.01
mu_2 = âˆ’0.0007
sigma_2 = 0.02
m = 2

param0=matrix(c(mu_1, sigma_1, mu_2, sigma_2), m, 2, byrow=TRUE)
gamma0=ldhmm.gamma_init(m)
h <- ldhmm(m, param0, gamma0, stationary=TRUE)
hd <- ldhmm.mle(h, ts$x, decode = TRUE, print.level =2)
hd@param
hd@gamma
hd@delta

ldhmm.ld_stats(hd)

hd@states.local.stats

<<<<<<< HEAD
ldhmm.ld_stats(hd)
=======
###Random forest - all variables
>>>>>>> c435cff489682a23339f90ebb4d59d17c562f9eb

ldhmm.calc_stats_from_obs(hd, drop=11)

ldhmm.oxford_man_plot_obs(hd)

```



```{r hmm_2}
states_prob <- t(as.data.frame(hd@states.global.stats))

write.csv(states_prob,"states_prob.csv")


```

```{r hmm_3}

<<<<<<< HEAD
hs<-ldhmm.simulate_state_transition(hd, init =100000)
kurtosis(hs@observations)

ldhmm.simulate_abs_acf(hd, n=100000, lag.max =1)

```
=======
###Random forest - only dynamic variables

```{r random_forest}
start_time <- Sys.time()
model_forest_dynamic <- randomForest(MOVEMENT.T.0~ vwretd + vwretx + ewretd + ewretx + totval + totcnt + usdval + usdcnt + spindx + sprtrn + VOL.T.5.4 + VOL.T.4.3 + VOL.T.3.2 + VOL.T.2.1, data=training, importance=TRUE, proximity=TRUE, type="classification")
print(model_forest_dynamic)
end_time <- Sys.time()
end_time - start_time

plot(model_forest)
importance(model_forest)
varImpPlot(model_forest)
```


Finding predicitons: probabilities and classification

```{r rf_predictions}
forest_probabilities_dynamic<-predict(model_forest_dynamic,newdata=testing,type="prob") 
forest_classification_dynamic<-rep("0",length(testing$MOVEMENT.T.0))
forest_classification_dynamic[forest_probabilities_dynamic[,2]>0.2]="1"
forest_classification_dynamic<-as.factor(forest_classification_dynamic)
confusionMatrix(forest_classification_dynamic,testing$MOVEMENT.T.0, positive="1")
```


##ROC Curve
```{r rf_roc}
forest_ROC_prediction_dynamic <- prediction(forest_probabilities_dynamic[,2], testing$MOVEMENT.T.0)
forest_ROC_prediction_dynamic <- performance(forest_ROC_prediction_dynamic,"tpr","fpr")
plot(forest_ROC_prediction_dynamic)
```

##AUC (area under curve)
```{r rf_auc}
AUC.tmp <- performance(forest_ROC_prediction_dynamic,"auc") 
forest_AUC <- as.numeric(AUC.tmp@y.values) 
forest_AUC 
```

##Lift chart
```{r rf_lift}
plotLift(forest_probabilities_dynamic[,2],  testing$MOVEMENT.T.0, cumulative = TRUE, n.buckets = 10)
```
## GLM model

```{r}
model_logistic_glm <- glm(MOVEMENT.T.0~., data=training, family="binomial"(link="logit"))
summary(model_logistic_glm)

model_logistic_stepwiseAIC<-stepAIC(model_logistic_glm,direction = c("both"),trace = 1) #AIC stepwise
summary(model_logistic_stepwiseAIC)
```

```{r glm_steps}
model_logistic_stepwiseAIC<-stepAIC(model_logistic_glm,direction = c("both"),trace = 1) #AIC stepwise
summary(model_logistic_stepwiseAIC)
```

```{r glm_plots}
par(mfrow=c(1,4))
plot(model_logistic_stepwiseAIC)
par(mfrow=c(1,1))
```

##GLM model prediction

Predict classification using 0.6 threshold. Why? Random guess! 
An alternative code: logistic_classification <- as.integer(logistic_probabilities > mean(testing$Default.0 == "1"))

```{r glm_predictions}
logistic_probabilities<-predict(model_logistic_stepwiseAIC,newdata=testing,type="response") 
logistic_classification<-rep("0",length(testing$MOVEMENT.T.0))
logistic_classification[logistic_probabilities>1-0.6]="1"
logistic_classification<-as.factor(logistic_classification)
```

##GLM Confusion matrix
```{r glm_confusion_matrix}
glm_cm<-confusionMatrix(logistic_classification, testing$MOVEMENT.T.0, positive = "1")
glm_cm
```

##GLM ROC Curve
```{r glm_ROC}
logistic_ROC_prediction <- prediction(logistic_probabilities, testing$MOVEMENT.T.0)
logistic_ROC <- performance(logistic_ROC_prediction,"tpr","fpr") 
plot(logistic_ROC)
```

## Ctree
```{r ctree}
ctree_tree<-ctree(MOVEMENT.T.0~.,data=training) 
plot(ctree_tree, gp = gpar(fontsize = 8)) 
ctree_probabilities<-predict(ctree_tree,newdata=testing,type="prob")
ctree_classification<-rep("0",length(testing$MOVEMENT.T.0))
ctree_classification[ctree_probabilities[,2]>1-0.9999]="1" 
ctree_classification<-as.factor(ctree_classification)
```

##CTREE confustion matrix
```{r ctree_confusion_matrix}
ctree_cm<-confusionMatrix(ctree_classification, testing$MOVEMENT.T.0,positive = "1")
ctree_cm
```

##Predict probabilities and calculate errors
```{r rpart_prediction_prob}
ctree_probabilities_testing <-predict(ctree_tree,newdata=testing,type = "prob")
ctree_pred_testing <- prediction(ctree_probabilities_testing[,2], testing$MOVEMENT.T.0)
```

##ROC
```{r rpart_roc}
ctree_ROC_testing <- performance(ctree_pred_testing,"tpr","fpr")
plot(ctree_ROC_testing)
```
>>>>>>> c435cff489682a23339f90ebb4d59d17c562f9eb
