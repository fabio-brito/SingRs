---
title: "Project_SingRs"
output: html_document
date: "February 16, 2019"
---

##Introduction

Business objective
We are seeing whether we can predict the movement of the S&P 500 index based on a number of factors at T-30 days, T-2 days and T-1 day.

Data
We downloaded S&P data from CRSP, the Wharton data platform for financial data.

Process
We began by downloading and cleaning the data, and splitting it into testing and training. 

We  then tried several models to predict the movement of the stock, namely Random Forest, an ETS Arima model, and finally the Hidden Markov Model, and compared the results of each. 

Results
Success was mixed - ADD MORE HERE

Acknowledgement: Christos Oikonomou, Frederico Belo, Ahmed Guecioueur
Reproduction of Hidden Markov Model for Financial Time Series and Its Application to S&P 500 Index by Stephen H.-T. Lihn (https://cran.r-project.org/web/packages/ldhmm/vignettes/ldhmm-spx.pdf)


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE}
if("pacman" %in% rownames(installed.packages()) == FALSE) {install.packages("pacman")}
pacman::p_load("caret","ROCR","lift","glmnet","MASS","e1071",'dplyr',
               "partykit","rpart", "munsell","caTools", "caret", "randomForest") 

require('xts')
require('quantmod')
library(ldhmm)
library(moments)
library(forecast)
library(fpp)
library(xts)
library(scales)

```

#Part 1. Prediction of S&P500 movement using Random Forest 
## Load data
```{r data_loading}
p1_data_general <- read.csv("sp500_master_woT0.csv")
data_working <- p1_data_general
```


###Split the data into testing and training
```{r data_split_cleaning}
data_working$caldt <- as.Date(as.character(data_working$caldt), "%Y%m%d")
data_working$Movement.T.0 <- as.factor(data_working$Movement.T.0)

str(data_working)

train_general <- data_working[1:3500,]
test_general <- data_working[3501:4469,]
test_general_womov <- test_general
test_general_womov$MOVEMENT.T.0 <- NULL

set.seed(77300) 
inTrain <- createDataPartition(y = train_general$Movement.T.0, p = 0.7, list = FALSE)
training <- train_general[ inTrain,]
testing <- train_general[ -inTrain,]
```

###Random forest - only dynamic variables

```{r random_forest}
start_time <- Sys.time()
model_forest <- randomForest(Movement.T.0~., data=training, importance=TRUE, proximity=TRUE,  type="classification")
print(model_forest)
end_time <- Sys.time()
end_time - start_time

plot(model_forest)
importance(model_forest)
varImpPlot(model_forest)
```


Finding predicitons: probabilities and classification

```{r rf_predictions}
forest_probabilities<-predict(model_forest,newdata=testing,type="prob") 
forest_classification<-rep("0",length(testing$Movement.T.0))
forest_classification[forest_probabilities[,2]>0.5]="1"
forest_classification<-as.factor(forest_classification)
confusionMatrix(forest_classification,testing$Movement.T.0, positive="1")
```


###ROC Curve
```{r rf_roc}
forest_ROC_prediction <- prediction(forest_probabilities[,2], testing$Movement.T.0)
forest_ROC_prediction <- performance(forest_ROC_prediction,"tpr","fpr")
plot(forest_ROC_prediction)
```

###AUC (area under curve)
```{r rf_auc}
AUC.tmp <- performance(forest_ROC_prediction,"auc") 
forest_AUC <- as.numeric(AUC.tmp@y.values) 
forest_AUC 
```

###Lift chart
```{r rf_lift}
plotLift(forest_probabilities[,2],  testing$Movement.T.0, cumulative = TRUE, n.buckets = 10)
```


#Part 2. Forecasting S&P500 movement using time series analysis

###Description 

###Loading the data
```{r p2_dataloading}
getSymbols(c("^GSPC","^VIX"),from = as.Date("2009-01-01"), to = as.Date("2019-02-14"))

vix_data = as.data.frame(merge(GSPC,VIX))
vix_data <- data.frame(date = row.names(vix_data), vix_data, row.names = NULL)

plot (vix_data$date,vix_data$GSPC.Adjusted)
lines(vix_data$date,vix_data$GSPC.Adjusted,col="blue")

par(new = TRUE)
plot (vix_data$date,vix_data$VIX.Adjusted,type = "l", axes = FALSE, bty = "n", xlab = "", ylab = "")
lines(vix_data$date,vix_data$VIX.Adjusted,col="red")
axis(side=4, at = pretty(range(vix_data$VIX.Adjusted)))
abline(h=20,col = "gray60")
abline(h=30,col = "green")
```



```{r time_series_analysis}
vix_model <- ets(vix_data$VIX.Adjusted, model = "ZZZ")

vix_model_pred <- forecast(vix_model, h=252)

plot(vix_model_pred)


vix_model_arima <- auto.arima(vix_data$VIX.Adjusted,seasonal=FALSE)

#automatically fits the ARIMA model (auto-regressive integrated moving average)
acf(residuals(vix_model_arima))
plot(forecast(vix_model_arima,252))
```



#Part 3. Forecasting S&P500 movement using Hidden Markov Model 

```{r hmm}

ts = ldhmm.ts_log_rtn("spx", on ="days")
sapply(0:10, function (drop) kurtosis(ldhmm.drop_outliers(ts$x, drop)))
ldhmm.ts_abs_acf(ts$x,drop =0 , lag.max =6)
ldhmm.ts_abs_acf(ts$x,drop =10, lag.max =6)


mu_1 = 0.0006
sigma_1 = 0.01
mu_2 = â.’0.0007
sigma_2 = 0.02
m = 3

param0=matrix(c(mu_1, sigma_1, mu_2, sigma_2), m, 2, byrow=TRUE)
gamma0=ldhmm.gamma_init(m)
h <- ldhmm(m, param0, gamma0, stationary=TRUE)
hd <- ldhmm.mle(h, ts$x, decode = TRUE, print.level =2)
hd@param
hd@gamma
hd@delta

ldhmm.ld_stats(hd)
hd@states.local.stats
ldhmm.ld_stats(hd)


ldhmm.calc_stats_from_obs(hd, drop=11)
ldhmm.oxford_man_plot_obs(hd, insert.plot = FALSE)
ldhmm.plot_spx_vix_obs(hd, end.date = as.Date("2019-02-14"),insert.plot = FALSE)

```


#Part 4. Lessons learned

Predicting the movement of a stock is difficult! This makes sense, as stock movements rely on a lot more than simply the factors captured in the data - sentiment analysis, market movements, political events - so our model was unlikely to be able to predict much of the variance.


