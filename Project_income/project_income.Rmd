---
title: "Introduction to linear regression"
output:
  pdf_document: default
  html_notebook: default
---

In this notebook, we show you how to perform a linear regression in R.

# Load required packages
```{r, echo=FALSE}
if("pacman" %in% rownames(installed.packages()) == FALSE) {install.packages("pacman")} # Check if you have universal installer package, install if not

pacman::p_load("caret","ROCR","lift","glmnet","MASS","e1071",'dplyr', "xgboost", "party",
               "partykit","rpart", "munsell","caTools", "caret", "randomForest", "readxl") #Check, and if needed install the necessary packages
```


```{r data_loading}
data_training <- read_excel("adult.data.xlsx", sheet =1, col_names = TRUE, na = '')
data_testing <- read_excel("adult.test.xlsx", sheet =1, col_names = TRUE, na = '')

str(data_training)
str(data_testing)
```
## Data adjustments

```{r}
# combined_data$brand_agegroup <- 0
# combined_data$brand_agegroup[combined_data$brand_age >=0   & combined_data$brand_age <50]  <- 1
# combined_data$brand_agegroup[combined_data$brand_age >=50  & combined_data$brand_age <100] <- 2
# combined_data$brand_agegroup[combined_data$brand_age >=100 & combined_data$brand_age <150] <- 3
# combined_data$brand_agegroup[combined_data$brand_age >=150 & combined_data$brand_age <200] <- 4
# combined_data$brand_agegroup[combined_data$brand_age >=200] <- 5
# 
# 
data_training$age <- as.integer(data_training$age)
data_training$workclass <- as.factor(data_training$workclass)
data_training$education_num <- as.integer(data_training$education_num)
data_training$marital_status <- as.factor(data_training$marital_status)
data_training$occupation <- as.factor(data_training$occupation)
data_training$race <- as.factor(data_training$race)
data_training$relationship <- as.factor(data_training$relationship)
data_training$sex <- as.factor(data_training$sex)
data_training$native_country <- as.factor(data_training$native_country)
data_training$education <- as.factor(data_training$education)
data_training$more_50k <- as.factor(data_training$more_50k)

data_testing$age <- as.integer(data_testing$age)
data_testing$workclass <- as.factor(data_testing$workclass)
data_testing$education_num <- as.integer(data_testing$education_num)
data_testing$marital_status <- as.factor(data_testing$marital_status)
data_testing$occupation <- as.factor(data_testing$occupation)
data_testing$race <- as.factor(data_testing$race)
data_testing$relationship <- as.factor(data_testing$relationship)
data_testing$sex <- as.factor(data_testing$sex)
data_testing$native_country <- as.factor(data_testing$native_country)
data_testing$education <- as.factor(data_testing$education)
data_testing$more_50k <- as.factor(data_testing$more_50k)


# levels(data_testing$workclass) <- levels(data_training$workclass)
# levels(data_testing$education) <- levels(data_training$education)
# levels(data_testing$native_country) <- levels(data_training$native_country)
# levels(data_testing$sex) <- levels(data_training$sex)
# levels(data_testing$relationship) <- levels(data_training$relationship)
# levels(data_testing$occupation) <- levels(data_training$occupation)
# levels(data_testing$marital_status) <- levels(data_training$marital_status)
# levels(data_testing$race) <- levels(data_training$race)

str(data_training)
str(data_testing)
```

```{r}
# linear_model <- lm(more_50k ~ ., data=data_training)
# summary(linear_model)
```

## GLM

```{r glm}
model_logistic_glm <- glm(more_50k ~ ., data=data_training, family="binomial"(link="logit"))
summary(model_logistic_glm)
```

```{r glm_stepAIC}
model_logistic_stepwiseAIC<-stepAIC(model_logistic_glm, direction = c("both"), trace = 1)
summary(model_logistic_stepwiseAIC)
```

##GLM model prediction

```{r glm_predictions}
logistic_probabilities<-predict(model_logistic_stepwiseAIC,newdata=data_testing,type="response") 
logistic_classification<-rep("0",length(data_testing$more_50k))
logistic_classification[logistic_probabilities>0.29]="1"
logistic_classification<-as.factor(logistic_classification)
```

##GLM Confusion matrix
```{r glm_confusion_matrix}
glm_cm<-confusionMatrix(logistic_classification, data_testing$more_50k, positive = "1")
glm_cm
```

##GLM ROC Curve
```{r glm_ROC}
logistic_ROC_prediction <- prediction(logistic_probabilities, data_testing$more_50k)
logistic_ROC <- performance(logistic_ROC_prediction,"tpr","fpr") 
plot(logistic_ROC)
```

##GLM AUC (area under curve)
```{r glm_AUC}
auc.tmp <- performance(logistic_ROC_prediction,"auc")
logistic_auc_testing <- as.numeric(auc.tmp@y.values)
logistic_auc_testing
```


#CTREE
Plotting the tree (adjust fontsize if needed)
Predict probabilities

```{r ctree}
ctree_tree<-ctree(more_50k ~ . ,data=data_training) 
plot(ctree_tree, gp = gpar(fontsize = 8)) 
ctree_probabilities<-predict(ctree_tree,newdata=data_testing,type="prob")
ctree_classification<-rep("0",length(data_testing$more_50k))
ctree_classification[ctree_probabilities[,2]>0.3]="1" 
ctree_classification<-as.factor(ctree_classification)
```

##CTREE confustion matrix
```{r ctree_confusion_matrix}
ctree_cm<-confusionMatrix(ctree_classification, testing$default_0,positive = "1")
ctree_cm
```

##Predict probabilities and calculate errors
```{r rpart_prediction_prob}
ctree_probabilities_testing <-predict(ctree_tree,newdata=testing,type = "prob")
ctree_pred_testing <- prediction(ctree_probabilities_testing[,2], testing$default_0)
```

##ROC
```{r rpart_roc}
ctree_ROC_testing <- performance(ctree_pred_testing,"tpr","fpr")
plot(ctree_ROC_testing)
```

##AUC
```{r rpart_auc}
ctree_auc.tmp <- performance(ctree_pred_testing,"auc") 
ctree_auc_testing <- as.numeric(ctree_auc.tmp@y.values)
ctree_auc_testing
```


#xgboost
```{r xgboost}
start_time <- Sys.time()

training.x <- model.matrix(more_50k~ .  , data = data_training)
testing.x  <- model.matrix(more_50k ~ . , data = data_testing)

model_XGboost<-xgboost(data = data.matrix(training.x[,-1]), 
                       label = as.numeric(as.character(data_training$more_50k)), 
                       eta = 0.1,
                       max_depth = 20, 
                       nround=50, 
                       objective = "binary:logistic")
end_time <- Sys.time()
end_time - start_time
```

##Predict classification (for confusion matrix)
```{r xgb_predictions}
XGboost_prediction<-predict(model_XGboost,newdata=testing.x[,-1], type="response") 
```

###Display confusion matrix
```{r xgb_cm}
xgb_cm<-confusionMatrix(as.factor(ifelse(XGboost_prediction>0.29,1,0)),data_testing$more_50k,positive="1")
xgb_cm
```
##ROC Curve
```{r xgb_roc}
XGboost_pred_testing <- prediction(XGboost_prediction, data_testing$more_50k) 
XGboost_ROC_testing <- performance(XGboost_pred_testing,"tpr","fpr")
plot(XGboost_ROC_testing)
```
##AUC
```{r xgb_auc}
auc.tmp <- performance(XGboost_pred_testing,"auc")
XGboost_auc_testing <- as.numeric(auc.tmp@y.values)
XGboost_auc_testing 
```